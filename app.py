import io
from typing import Dict, List, Tuple

import matplotlib
matplotlib.use("Agg")  # GUI ì—†ëŠ” ì„œë²„ í™˜ê²½ìš©
import matplotlib.pyplot as plt
import pandas as pd
import streamlit as st


# =========================================
# ê¸°ë³¸ ì„¤ì • & ì„¸ì…˜ ìƒíƒœ
# =========================================
st.set_page_config(page_title="ê³ ë“±í•™ìƒ ì§„ë¡œ MBTI ê²€ì‚¬", layout="wide")

if "idx" not in st.session_state:
    st.session_state.idx = 0          # í˜„ì¬ ë¬¸í•­ index
if "answers" not in st.session_state:
    st.session_state.answers = {}     # id -> code(E/I/â€¦)
if "finished" not in st.session_state:
    st.session_state.finished = False # ê²€ì‚¬ ì™„ë£Œ ì—¬ë¶€


# =========================================
# 1) mbti.csv ë¡œë”© (clean_mbti í˜•ì‹)
#    í•„ìš”í•œ ì»¬ëŸ¼:
#    id, dimension_pair, question,
#    option_a_text, option_a_code,
#    option_b_text, option_b_code
# =========================================
@st.cache_data
def load_mbti(csv_path: str = "mbti.csv") -> pd.DataFrame:
    try:
        df = pd.read_csv(csv_path, encoding="utf-8-sig")
    except UnicodeDecodeError:
        df = pd.read_csv(csv_path, encoding="cp949")

    df = df.loc[:, ~df.columns.str.contains("Unnamed")]

    required = [
        "id",
        "dimension_pair",
        "question",
        "option_a_text",
        "option_a_code",
        "option_b_text",
        "option_b_code",
    ]
    missing = [c for c in required if c not in df.columns]
    if missing:
        raise ValueError(
            f"mbti.csvì— ë‹¤ìŒ ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤: {missing}\n"
            "í˜„ì¬ íŒŒì¼ì´ clean_mbti í…œí”Œë¦¿ê³¼ ê°™ì€ êµ¬ì¡°ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”."
        )

    df["id"] = df["id"].astype(int)
    df["question"] = df["question"].astype(str)
    df.loc[df["question"].isin(["nan", "", "None"]), "question"] = df["id"].apply(
        lambda x: f"{x}ë²ˆ ë¬¸í•­"
    )
    return df


df = load_mbti()


# =========================================
# 2) ê° ìœ í˜•ë³„ ê¸´ ì„¤ëª… (ì‚¬ìš©ìê°€ ì¤€ ë¬¸ì¥ë“¤)
# =========================================
MBTI_PROFILES: Dict[str, List[str]] = {
    "ISTJ": [
        "ï¼Šë¶€ë„ëŸ¼ì„ ë§ì´ íƒ„ë‹¤.",
        "ï¼Šì„±ì‹¤í•˜ê³  ì±…ì„ê°ì´ ê°•í•˜ê³  ì •ë¦¬ì •ëˆì„ ì˜í•œë‹¤.",
        "ï¼Šì˜ˆì •ì— ì—†ë˜ ì¼ì„ ëª¹ì‹œ í˜ë“¤ì–´í•œë‹¤.",
        "ï¼Šìë°œì„±ì´ ë¶€ì¡±í•œ í¸ì´ë‹¤.",
        "ï¼Ší‘œí˜„ì´ ì ìœ¼ë©° í‘œì •ë³€í™”ê°€ ì—†ë‹¤.",
        "ï¼Šì ˆì•½ê³¼ ì¤€ë¹„ì •ì‹ ì´ ì² ì €í•˜ë‹¤.",
        "ï¼Šì–‘ì²˜ëŸ¼ ìˆœí•˜ê³  ìˆœì¢…ì ì´ë‹¤.",
        "ï¼Šì™¸ìœ ë‚´ê°•ì˜ ëŠë‚Œì„ ì¤€ë‹¤.",
        "ï¼Šìì„¸ê°€ ë°”ë¥´ë©° ê³„íšì„ ì„¸ì›Œ ê³µë¶€í•œë‹¤.",
        "ï¼Šìì„¸í•œ ì„¤ëª…ì„ ì„ í˜¸í•œë‹¤.",
        "ï¼Šì°½ì˜ì ì¸ ë©´ê³¼ ìœµí†µì„±ì´ ë¶€ì¡±í•œ í¸ì´ë‹¤.",
    ],
    "ISTP": [
        "ï¼Šë§ìˆ˜ê°€ ì ê³  í‘œì •ë³€í™”ê°€ ê±°ì˜ ì—†ë‹¤.",
        "ï¼Šì˜ìš•ì ì´ë©° ê³ ì§‘ì´ ì„¸ë‹¤.",
        "ï¼Šì•ì— ë‚˜ì„œì§€ëŠ” ì•Šì§€ë§Œ ì†Œì§‘ë‹¨ì—ì„œëŠ” ë¦¬ë” ì—­í• ì„ í•˜ë ¤ê³  í•œë‹¤.",
        "ï¼Šì—¬ëŸ¬ ê°€ì§€ì— ê´€ì‹¬ì´ ë§ë‹¤.",
        "ï¼Šì™ ì§€ ê°•í•œ êµ¬ì„ì´ ìˆë‹¤.",
        "ï¼Šë’·ë§ˆë¬´ë¦¬ê°€ ë¶€ì¡±í•˜ë‹¤. ëˆê¸°ê°€ ë¶€ì¡±í•˜ë‹¤.",
        "ï¼Šíƒ€ì¸ì— ëŒ€í•œ ë°°ë ¤ê°€ ì ë‹¤.",
        "ï¼Šì†ì¬ì£¼ê°€ ìˆë‹¤.",
        "ï¼Šì¹œêµ¬ì™€ ì˜ ë‹¤íˆ¬ê³  ì˜ ë”°ì§„ë‹¤.",
        "ï¼Šì¡°ìš©í•˜ë‹¤ê°€ë„ ì¼ì€ ì„±ê¸‰í•˜ê²Œ í•œë‹¤.",
    ],
    "ESTP": [
        "ï¼Šê°œë°©ì , í™œë™ì , ì ê·¹ì , ì§„ì·¨ì ì´ë‹¤.",
        "ï¼Ší•­ìƒ ì¦ê²ë‹¤. ì¬ì¹˜ê¾¼ì´ë‹¤.",
        "ï¼Šëª¨ë“  ì¼ì— ê´€ì‹¬ì„ ê°–ê³  ì§€ë‚˜ì¹˜ê²Œ ì°¸ê²¬í•œë‹¤.",
        "ï¼Šëë§ˆë¬´ë¦¬ê°€ ë¶€ì¡±í•˜ê³  ë§ê³¼ í–‰ë™ì— ë¶ˆì¼ì¹˜ê°€ ìˆë‹¤.",
        "ï¼Šë³µì¡í•œ ê²ƒì„ ì‹«ì–´í•œë‹¤.",
        "ï¼Šìš•ì‹¬ì´ ë§ë‹¤. ì€ê·¼íˆ ìŠ¹ë¶€ê·¼ì„±ì´ ê°•í•˜ë‹¤.",
        "ï¼ŠëŒ€ì¤‘ ì•ì— ê°•í•˜ë‹¤. ê³¼í–‰ë™ì ì´ê³  ëª©ì†Œë¦¬ê°€ í¬ë‹¤.",
        "ï¼Šë§ì´ ë§ê³  ì˜ ë”°ì§€ë©° ê¾¸ì¤‘ì„ í•´ë„ ìì‹ ì˜ ì…ì¥ì„ ëê¹Œì§€ ë§í•œë‹¤.",
        "ï¼Šì„ê¸°ì‘ë³€ì´ ë›°ì–´ë‚˜ê³  í˜¸íƒ•í•˜ë‹¤.",
        "ï¼Šì–´ë–¤ ê¶Œìœ„ë‚˜ ê°•ì••ì— êµ´í•˜ì§€ ì•ŠëŠ”ë‹¤.",
    ],
    "ESTJ": [
        "ï¼Šëª¨ë²”ì ì´ê³  ì†”ì„ ìˆ˜ë²”í•œë‹¤.",
        "ï¼Šì •ë¦¬ì •ëˆì„ ì˜í•˜ê³  ì±…ì„ê°ì´ ê°•í•˜ë‹¤.",
        "ï¼Šì›ƒì–´ë¥¸ì„ ê³µê²½í•˜ê³  ì˜ˆì˜ê°€ ë°”ë¥´ë‹¤.",
        "ï¼Ší•©ë¦¬ì ìœ¼ë¡œ ìƒê°í•˜ê³  ê³µì •í•œ ê²ƒì„ ì„ í˜¸í•œë‹¤.",
        "ï¼Šê²½ìŸì—ì„œëŠ” ì´ê²¨ì•¼ í•œë‹¤.",
        "ï¼Šì¹œêµ¬ë‚˜ ì£¼ë³€ ì‚¬ëŒì„ ë°°ë ¤í•˜ëŠ” ë¦¬ë” íƒ€ì…ì´ë‹¤.",
        "ï¼Šì§ˆì„œì™€ ì‚¬íšŒì ì¸ ê´€ìŠµì„ ì¤‘ì‹œí•œë‹¤.",
        "ï¼Šì—¬ëŸ¬ ì¹œêµ¬ë“¤ê³¼ ë‘ë£¨ ì˜ ì§€ë‚¸ë‹¤.",
        "ï¼Šì¹œì ˆí•˜ë‹¤. ì¤‘ì¬Â·íƒ€í˜‘Â·ë¶„ë°°ë¥¼ ì˜í•œë‹¤.",
        "ï¼Šë¶ˆí‰ì´ ì—†ë‹¤. í™œë°œí•˜ë‹¤.",
    ],
    "INFJ": [
        "ï¼Šì¡°ìš©í•˜ê³  ì¹¨ì°©í•˜ê³  ì±…ì„ê°ì´ ê°•í•˜ë‹¤.",
        "ï¼Šë‚´ë©´ì ì¸ ìš•ì‹¬ì´ ë§ê³  ì”ê±±ì •ì´ ë§ë‹¤.",
        "ï¼Šë˜ë˜ì— ë¹„í•´ ì„±ìˆ™í•œ ì‚¬ê³ ë ¥ì„ ì§€ë‹Œë‹¤.",
        "ï¼Šë¯¼ê°í•˜ê³  ë³µì¡í•œ ì •ì„œë¥¼ ê°€ì§€ê³  ë¹„ìœ ë¥¼ ì˜í•œë‹¤.",
        "ï¼Šêµì‚¬ì˜ ì˜ë„ë¥¼ ì˜ ì•Œì•„ì±ˆë‹¤.",
        "ï¼Šê°œì¸ì ì¸ ì¹­ì°¬ì„ í•´ì£¼ë©´ í¬ê²Œ í–¥ìƒëœë‹¤.",
        "ï¼Šì‹œë„ëŸ½ê³  ë³µì¡í•œ ê²ƒ, ë‚˜ì„œê¸°ë¥¼ ì‹«ì–´í•œë‹¤.",
        "ï¼Ší•™ê¸‰ì¼ì— ì ê·¹ì ìœ¼ë¡œ ì„í•˜ì§€ ì•ŠëŠ”ë‹¤.",
        "ï¼Šì™„ë²½ì„±ì„ ì¶”êµ¬í•˜ê³  ì†Œì™¸ë°›ëŠ” ì•„ë™ì— ê´€ì‹¬ì´ ë§ë‹¤.",
        "ï¼Šì¢‹ì•„í•˜ëŠ” ê²ƒê³¼ ì¢‹ì•„í•˜ì§€ ì•ŠëŠ” ê²ƒ ì°¨ì´ê°€ ì‹¬í•˜ë‹¤. êµì‚¬ì™€ì˜ ê´€ê³„ê°€ ì¢‹ìœ¼ë©´ ì—´ì‹¬íˆ ê³µë¶€í•œë‹¤.",
    ],
    "INFP": [
        "ï¼Šì¡°ìš©í•˜ê³  ë§ì´ ì—†ìœ¼ë‚˜ ë§ˆìŒì´ ê¹Šê³  ë”°ëœ»í•˜ë‹¤.",
        "ï¼Šì¹œêµ¬ë‚˜ ì£¼ë³€ ìƒí™©ì— ë¯¼ê°í•˜ê³  ì˜í–¥ì„ ë§ì´ ë°›ëŠ”ë‹¤.",
        "ï¼Šë¯¼ê°í•œ ì •ì„œì„¸ê³„, ë™ì •ì‹¬ì´ ë§ë‹¤. ì‚¬ë ¤ ê¹Šë‹¤.",
        "ï¼Šì•½ê°„ ëŠë¦¬ë©° ê¾¸ì¤€í•˜ì§€ ëª»í•˜ë‹¤.",
        "ï¼Šì‹¤ì²œë ¥ì´ ë¶€ì¡±í•˜ë‹¤. ë‚®ì ì„ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šì¢‹ì•„í•˜ëŠ” ê²ƒê³¼ ê·¸ë ‡ì§€ ì•Šì€ ê²ƒ ì‚¬ì´ì— ì°¨ì´ê°€ ë§ì´ ë‚œë‹¤.",
        "ï¼Šì˜¨í™”í•˜ê³  ë¶€ë“œëŸ½ë‹¤. ìì‹ ì˜ ê°€ì¹˜ë¥¼ ì¤‘ì‹œí•œë‹¤.",
        "ï¼Ší•™êµ ìƒí™œ íŒ¨í„´ì— ë”°ë¼ê°€ì§€ ëª»í•œë‹¤.",
        "ï¼Šìƒì§•ì— ëŒ€í•œ í•´ì„ì´ ë›°ì–´ë‚˜ë‹¤.",
        "ï¼Šêµì‚¬ ì…ì¥: ê¸°ë‹¤ë¦¼ì´ í•„ìš”í•œ ì•„ì´ë‹¤.",
    ],
    "ENFP": [
        "ï¼Šìˆœì§„í•˜ê³  ìˆœìˆ˜í•˜ë‹¤.",
        "ï¼Šë³€ë•ìŸì´, ê¸°ë°œí•˜ë‹¤.",
        "ï¼Šë¶„ìœ„ê¸°ë§Œ ë§ìœ¼ë©´ ê³¼ì‰í–‰ë™ì„ í•œë‹¤.",
        "ï¼Šì¢‹ì•„í•˜ëŠ” ê²ƒê³¼ ê·¸ë ‡ì§€ ì•Šì€ ê²ƒ ì‚¬ì´ì— ì§‘ì¤‘ë ¥ì˜ ì°¨ì´ê°€ ë‚œë‹¤.",
        "ï¼Šë”´ ìƒê°ì„ ì˜í•œë‹¤.",
        "ï¼Šì¹­ì°¬ì— ë¯¼ê°í•˜ë‹¤.",
        "ï¼Šìš©ëˆì´ í—¤í”„ë‹¤.",
        "ï¼Šì‚¬ëŒì„ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šë°˜ë³µ í›ˆë ¨Â·ì—°ìŠµì„ ì‹«ì–´í•œë‹¤.",
        "ï¼Šì •ë¦¬ì •ëˆì´ ì•ˆ ëœë‹¤.",
    ],
    "ENFJ": [
        "ï¼Šì˜¨ìˆœí•˜ê³  ì°©í•˜ë‹¤.",
        "ï¼Šì±…ì„ê°ì´ ê°•í•˜ê³  ì‹ ë¢°ê°ì„ ì¤€ë‹¤.",
        "ï¼Šì£¼ë³€ ìƒí™©ì— ì˜í–¥ì„ ë§ì´ ë°›ëŠ”ë‹¤.",
        "ï¼Šì •ë¦¬ì •ëˆì„ ì˜í•œë‹¤.",
        "ï¼Šë”´ ì„¸ê³„ì— ë¹ ì ¸ ìˆì„ ë•Œê°€ ì¢…ì¢… ìˆë‹¤.",
        "ï¼Šì˜ˆëŠ¥ì ì¸ ë¶„ì•¼ë¥¼ ì¢‹ì•„í•œë‹¤.",
        "ï¼ŠíŠ¹ì • ë¶„ì•¼ëŠ” ì§€ë‚˜ì¹  ì •ë„ë¡œ ì§„ì§€í•˜ë‹¤.",
        "ï¼Šì°¸ì„ì„±ì´ ë§ë‹¤.",
        "ï¼Šì¹œêµ¬ë“¤ê³¼ ì˜ ì–´ìš¸ë¦°ë‹¤.",
        "ï¼Šëœ»ë°–ì˜ í–‰ë™ìœ¼ë¡œ ì£¼ë³€ì„ ë†€ë¼ê²Œ í•œë‹¤.",
        "ï¼Ší„°ì§ˆ ê²ƒ ê°™ì€ í™”ì‚°ì„ ë§ˆìŒì— í’ˆê³  ì‚¬ëŠ” ì•„ì´.",
    ],
    "ISFJ": [
        "ï¼Šì˜¨ìˆœí•˜ë‹¤. ì„±ì‹¤í•˜ê³  ì±…ì„ê°ì´ ê°•í•˜ë‹¤.",
        "ï¼Šë§ì„ ì°¸ê³  ì‚­ì´ëŠ” ê²½ìš°ê°€ ë§ë‹¤.",
        "ï¼Šë´‰ì‚¬ì ì´ë©° ì°©í•˜ë‹¤.",
        "ï¼Šì†Œìˆ˜ì™€ ê¹Šê²Œ ì‚¬ê·€ê³  ì¹œí•œ ì¹œêµ¬ì™€ ë…¼ë‹¤.",
        "ï¼Šì¸ë‚´ì‹¬ì´ ìˆìœ¼ë©° ê¾¸ì¤€í•˜ë‹¤.",
        "ï¼Šì¤€ë¹„ë¬¼ì„ ì˜ ì±™ê¸´ë‹¤. ê¹”ë” ë‹¨ì •í•˜ë‹¤.",
        "ï¼Šê·œì¹™ì„ ì¤€ìˆ˜í•˜ë©° ê³„íšì ì´ë‹¤.",
        "ï¼Ší–‰ë™ë ¥ì´ ë¶€ì¡±í•˜ë‹¤.",
        "ï¼Šì‹ ë¢°ê°ì´ ê°„ë‹¤.",
        "ï¼Šë³€í™”ë¥¼ ì‹«ì–´í•œë‹¤.",
        "ï¼Šë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë„ì›€ì´ ë˜ê³ ì í•˜ëŠ” ìš•êµ¬ê°€ í¬ë‹¤.",
    ],
    "ISFP": [
        "ï¼Šë§ˆìŒì´ ë„ˆê·¸ëŸ½ê³  ìˆœí•˜ë‹¤.",
        "ï¼Šë‚™ì²œì ì´ê³  ì²œí•˜íƒœí‰, í–‰ë™ì´ ëŠë¦¬ë‹¤.",
        "ï¼Šë†€ ì¤„ ì•Œë©° ë¬´ëŒ€ ì²´ì§ˆì´ê³  ì˜ˆìˆ ì  ë§¤ì²´ë¥¼ í†µí•´ ìì‹ ì„ ë“œëŸ¬ë‚´ëŠ” ê²ƒì„ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šì„±ê¸‰í•œ ê²°ë¡ ì„ ì˜ ë‚´ë¦°ë‹¤.",
        "ï¼Šëˆê¸°ê°€ ë¶€ì¡±í•˜ë‹¤.",
        "ï¼Šë¶€ë„ëŸ¼ì„ ë§ì´ íƒ€ê³  ì™¸ëª¨ì— ê´€ì‹¬ì´ ë§ë‹¤.",
        "ï¼Šë™ì‹ë¬¼ ì‚¬ìœ¡ì´ë‚˜ ì¬ë°°ë¥¼ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šê¶Œìœ„ì ì¸ ë¶„ìœ„ê¸°ì—ì„œëŠ” ëˆˆì¹˜ë¥¼ ì‚´í•€ë‹¤.",
        "ï¼Šì”ì”í•˜ê²Œ ì‚°ë§Œí•œ í¸ì´ë‹¤.",
        "ï¼Šì£¼ë³€ì˜ ìš”êµ¬ë¥¼ ë¿Œë¦¬ì¹˜ì§€ ëª»í•œë‹¤.",
    ],
    "ESFP": [
        "ï¼Ší™œë°œí•˜ë‹¤. ì²œë°©ì§€ì¶•ì´ê³  ê³¼ì‰í–‰ë™ì„ í•˜ë©° ë¨¹ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ê³  ê°ì •ì ì´ë‹¤.",
        "ï¼Ší‘œì •ì´ ë°ë‹¤. ëª©ì†Œë¦¬ê°€ í¬ê³  ë§ì´ ë§ë‹¤.",
        "ï¼Šì–¸ì œë‚˜ ë†€ê³  ì‹¶ë‹¤. ë‹¨ìˆœí•˜ê³  ì†”ì§í•˜ë‹¤.",
        "ï¼Šì¥ë‚œì´ ì‹¬í•˜ê³  ë¶™ì„ì„±ì´ ìˆë‹¤.",
        "ï¼Šì§€ì ì„ ë§ì´ ë°›ì•„ ìì‹ ì„ ì°©í•˜ë‹¤ê³  ìƒê°í•˜ì§€ ì•ŠëŠ”ë‹¤.",
        "ï¼Šë­ë“ ì§€ ê¸‰í•˜ê²Œ í•´ì¹˜ìš´ë‹¤.",
        "ï¼Šì ì‘ë ¥ì´ ë›°ì–´ë‚˜ë‹¤. (í•™ì›ì„ ë¹¼ë¨¹ì§„ ì•ŠìŒ).",
        "ï¼Šì§„ì§€í•¨ì´ ë¶€ì¡±í•˜ë‹¤. ì‹¤ì „ì— ë¶ˆì•ˆí•´í•œë‹¤.",
        "ï¼Šgroup studyê°€ íš¨ê³¼ì ì´ë©° ì„ ì˜ì˜ ê²½ìŸì„ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šì¸ì •ë°›ê³  ì‹¶ì€ ìš•êµ¬ê°€ ê°•í•˜ë‹¤.",
    ],
    "ESFJ": [
        "ï¼Šëª…ë‘ì¾Œí™œí•˜ê³  ê°ì •ì´ í’ë¶€í•˜ë‹¤. í™œë ¥ì†Œ ê°™ì€ ì•„ì´.",
        "ï¼Šíƒ€ì¸ì˜ ë¬´ê´€ì‹¬ì— ì‰½ê²Œ ì¢Œì ˆí•œë‹¤.",
        "ï¼Šë‚¨ ì•ì— ë‚˜ì„œê¸°ë¥¼ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šêµì‹¤ì„ ê¾¸ë¯¸ëŠ” ì¼ì„ ì˜í•œë‹¤.",
        "ï¼Šë¯¸ë¦¬ ê±±ì •í•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤.",
        "ï¼Šì™•ì„±í•œ ë°œí‘œë ¥, ì–¸ì–´ ê³„ì—´ì„ ì„ í˜¸í•œë‹¤.",
        "ï¼Ší‘œí˜„ë ¥ê³¼ ë¦¬ë”ì‹­ì´ ë›°ì–´ë‚˜ë‹¤.",
        "ï¼Šì¼ê¸°ë¥¼ ì˜ ì“°ê³  ìš´ë™ì„ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šì´ì•¼ê¸° ì¤‘ì‹¬ì˜ ì†Œì„¤ë¥˜ë¥¼ ë§ì´ ì½ëŠ”ë‹¤.",
        "ï¼Šë¶„ëª…í•œ ê³¼ì œì™€ ìì„¸í•œ ì„¤ëª…ì„ ì¢‹ì•„í•œë‹¤.",
        "ï¼Šë§ì´ ë§ë‹¤.",
    ],
    "INTJ": [
        "ï¼Šâ€œì• ëŠ™ì€ì´â€ ê°™ê³  ì†Œìˆ˜ì™€ ê¹Šê²Œ ì‚¬ê·„ë‹¤.",
        "ï¼Šì™¸ëª¨ì— ë¬´ê´€ì‹¬í•˜ë©° ë…ë¦½ì Â·ë…ì°½ì ì´ê³  íš¨ìœ¨ì„±ì„ ê°•ì¡°í•œë‹¤.",
        "ï¼Šê³ ì§‘ì´ ì•„ì£¼ ì„¸ê³  ëŒ€ë‹¨íˆ ê°•í•˜ë‹¤.",
        "ï¼Šì¶©ë¶„í•œ ì‹œê°„ì„ ì£¼ëŠ” ê²ƒì´ í•„ìš”í•œ íƒ€ì…ì´ë‹¤.",
        "ï¼Šì´ìœ ê°€ íƒ€ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ëê¹Œì§€ ìŠ¹ë³µí•˜ì§€ ì•ŠëŠ”ë‹¤. ëª¨ë“  ì¼ì— ì´ìœ ê°€ ë§ë‹¤.",
        "ï¼Šì´ë¡ ì ìœ¼ë¡œ, ë…¼ë¦¬ì ìœ¼ë¡œ ë”°ì§„ë‹¤.",
        "ï¼Šê°ì • í‘œí˜„ì€ ì—†ìœ¼ë‚˜ ìƒì²˜ë¥¼ ì‰½ê²Œ ë°›ëŠ”ë‹¤.",
        "ï¼Šì¹­ì°¬ì´ë‚˜ ë²Œì— ë¬´ê´€ì‹¬í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ë§ì€ ì¹­ì°¬ì´ í•„ìš”í•˜ë‹¤.",
        "ï¼ŠìŠ¹ë¶€ìš•ì´ ê°•í•˜ê³  ì´ê¸¸ ë•Œê¹Œì§€ í•œë‹¤.",
        "ï¼Šì‚¬ì†Œí•œ ì˜·, ë¨¹ëŠ” ì´ì•¼ê¸°ë§Œ í•˜ë©´ ì†ìƒí•´í•œë‹¤.",
    ],
    "INTP": [
        "ï¼Šë§Œë¬¼ë°•ì‚¬ íƒ€ì…ìœ¼ë¡œ ë…¼ë¦¬ì ì´ê³  í˜¸ê¸°ì‹¬ì´ ë§ë‹¤.",
        "ï¼Šì£¼ê´€ì´ ê°•í•˜ê³  ê³ ì§‘ì´ ì„¸ë©° ì†”ì§í•˜ë‹¤.",
        "ï¼Šìê¸°ì¤‘ì‹¬ì ì´ê³  ê°„ì„­ì´ë‚˜ ì”ì†Œë¦¬ë¥¼ ì‹«ì–´í•œë‹¤.",
        "ï¼Šì£¼ë³€ ìƒí™©ì— ë³„ë¡œ ì˜í–¥ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤.",
        "ï¼Šì •ë¦¬ì •ëˆì„ ì˜ í•˜ì§€ ëª»í•˜ê³  ê°ì •ì´ ë‹¨ìˆœí•˜ë‹¤.",
        "ï¼Šì˜ëª»ëœ ì¼ì€ ê¼­ ì§€ì í•œë‹¤. í•™ê¸‰ì—ì„œ ì™¸í†¨ì´ê°€ ë˜ê¸°ë„ í•œë‹¤.",
        "ï¼Šê³¼í•™ ì˜ì—­ì— ê´€ì‹¬ì´ ë§ê³  ìš´ë™ì„ ì‹«ì–´í•œë‹¤.",
        "ï¼Šì˜ë‚œ ì²™í•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤.",
        "ï¼Šëª»í•˜ëŠ” ì¹œêµ¬ë¥¼ ë¬´ì‹œí•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤.",
        "ï¼Šê´€ì‹¬ì´ ì—†ëŠ” ì˜ì—­ì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.",
        "ï¼Šì•ì„ ë‚˜ëˆ„ì§€ ëª»í•˜ëŠ” ê³ ë…ì„ ëŠë¼ë©°, êµì‚¬ì˜ ë¯¿ìŒì´ ì¤‘ìš”í•˜ë‹¤.",
    ],
    "ENTP": [
        "ï¼Ší™œë°œí•˜ë©° ë…ì°½ì ì´ë‹¤.",
        "ï¼Šìƒìƒë ¥ê³¼ í‘œí˜„ë ¥ì´ ë›°ì–´ë‚˜ë‹¤.",
        "ï¼Šì¹œêµ¬ë“¤ê³¼ ì˜ ì–´ìš¸ë¦°ë‹¤.",
        "ï¼Šê²Œìœ¼ë¥´ê³  ì •ë¦¬ì •ëˆì´ ì•ˆ ëœë‹¤.",
        "ï¼Šê°œì¸ì£¼ì˜ì  ê²½í–¥ì´ ìˆê³  ê³ ì§‘ì´ ê°•í•˜ë‹¤.",
        "ï¼Šë‹¤ë°©ë©´ì— ê´€ì‹¬ì„ ê°€ì§€ê³  ìˆëŠ” ë¶„ì•¼ê°€ ë§ë‹¤.",
        "ï¼Šë°˜ë³µ ì„¤ëª…ì„ ì‹«ì–´í•˜ê³  ìê¸° ë…¼ë¦¬ì— ë¹ ì§€ê¸° ì‰½ë‹¤.",
        "ï¼Šì‰½ê²Œ í¬ê¸°í•˜ëŠ” í¸ì´ê³  ë§ˆë¬´ë¦¬ê°€ ì•½í•˜ë‹¤.",
        "ï¼Šì¹œêµ¬ë¥¼ ë¦¬ë“œí•˜ë ¤ê³  í•œë‹¤.",
        "ï¼Šêµì‚¬ì˜ ê¶Œìœ„ë¥¼ ì˜ ì¸ì •í•˜ì§€ ëª»í•œë‹¤.",
        "ï¼Šêµì‚¬ê°€ ìê¸°ë¥¼ ì¸ì •í•´ ì£¼ëŠ” ê²ƒì„ ì¢‹ì•„í•œë‹¤.",
    ],
    "ENTJ": [
        "ï¼Šì›ë¦¬ì›ì¹™ì£¼ì˜ìë¡œ ìê¸° ì£¼ê´€ì´ ê°•í•˜ë‹¤.",
        "ï¼Ší™œë°œí•˜ë‹¤.",
        "ï¼Šë…¼ë¦¬ì ì¸ ì–¸ì–´ í‘œí˜„ì„ ì˜í•œë‹¤.",
        "ï¼Šê³ ì§‘ì´ ê°•í•˜ë‹¤.",
        "ï¼Šê°„ì„­ì„ ì‹«ì–´í•œë‹¤.",
        "ï¼Šì˜ëª»ëœ ê²ƒ, ë¶€ë‹¹í•œ ê²ƒì€ ê¼­ ë°”ë¡œì¡ê³  ë„˜ì–´ê°„ë‹¤.",
        "ï¼Šì² ì €í•œ ì¤€ë¹„ ìì„¸ë¥¼ ê°–ì¶”ê³  ìˆë‹¤.",
        "ï¼Ší†µì†”ë ¥ì´ ìˆë‹¤.",
        "ï¼Šê³„íší•˜ê³  ë§ˆìŒë¨¹ì€ ê²ƒì€ í•´ë‚¸ë‹¤.",
        "ï¼Šêµì‚¬ê°€ ì¸ì •í•´ì£¼ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.",
    ],
}


# =========================================
# 3) ê°„ë‹¨ ì§„ë¡œ ì¶”ì²œ (ì—†ìœ¼ë©´ 'ì¤€ë¹„ì¤‘' í‘œì‹œ)
# =========================================
MBTI_RECOMMENDATIONS: Dict[str, Dict[str, List[str]]] = {
    "INTJ": {
        "majors": ["ì»´í“¨í„°Â·ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™", "ë°ì´í„°ì‚¬ì´ì–¸ìŠ¤", "ê²½ì˜í•™", "ì •ì±…í•™"],
        "careers": ["ì „ëµê¸°íšì", "ë°ì´í„° ë¶„ì„ê°€", "ê²½ì˜ ì»¨ì„¤í„´íŠ¸", "í”„ë¡œë•íŠ¸ ë§¤ë‹ˆì €"],
    },
    "INFP": {
        "majors": ["ì‹¬ë¦¬í•™", "ì‚¬íšŒë³µì§€í•™", "êµ­ì–´êµ­ë¬¸Â·ì˜ë¬¸í•™", "ì½˜í…ì¸ Â·ë¬¸í™”ì˜ˆìˆ  ê´€ë ¨ ì „ê³µ"],
        "careers": ["ìƒë‹´Â·ë³µì§€ ë¶„ì•¼", "ì‘ê°€Â·ì—ë””í„°", "ì½˜í…ì¸  ê¸°íšì", "êµìœ¡ ê´€ë ¨ ì§ë¬´"],
    },
}


# =========================================
# 4) MBTI ê³„ì‚° & PNG ê·¸ë¦¼ ìƒì„±
# =========================================
def compute_mbti(df_items: pd.DataFrame, answers: Dict[int, str]) -> Tuple[str, Dict[str, int]]:
    scores = {k: 0 for k in ["E", "I", "S", "N", "T", "F", "J", "P"]}

    for _, row in df_items.iterrows():
        qid = row["id"]
        code = answers.get(qid)
        if code in scores:
            scores[code] += 1

    e_or_i = "E" if scores["E"] >= scores["I"] else "I"
    s_or_n = "S" if scores["S"] >= scores["N"] else "N"
    t_or_f = "T" if scores["T"] >= scores["F"] else "F"
    j_or_p = "J" if scores["J"] >= scores["P"] else "P"

    mbti_type = e_or_i + s_or_n + t_or_f + j_or_p
    return mbti_type, scores


def create_result_figure(
    mbti_type: str,
    scores: Dict[str, int],
    recommendations: Dict[str, List[str]],
) -> bytes:
    plt.rcParams["font.family"] = plt.rcParams.get("font.family", "sans-serif")

    fig, ax = plt.subplots(figsize=(7, 10))
    fig.suptitle("ê³ ë“±í•™ìƒ ì§„ë¡œ MBTI ê²°ê³¼ ìš”ì•½", fontsize=16, fontweight="bold")

    fig.text(
        0.5,
        0.92,
        f"MBTI ìœ í˜•: {mbti_type}",
        ha="center",
        va="center",
        fontsize=18,
        fontweight="bold",
    )

    y_labels = ["E / I", "S / N", "T / F", "J / P"]
    front_scores = [scores["E"], scores["S"], scores["T"], scores["J"]]
    back_scores = [scores["I"], scores["N"], scores["F"], scores["P"]]

    ax.barh(
        [y + 0.15 for y in range(len(y_labels))],
        front_scores,
        height=0.3,
        label="ì• ê¸€ì(E/S/T/J)",
    )
    ax.barh(
        [y - 0.15 for y in range(len(y_labels))],
        back_scores,
        height=0.3,
        label="ë’· ê¸€ì(I/N/F/P)",
    )

    ax.set_yticks(range(len(y_labels)))
    ax.set_yticklabels(y_labels, fontsize=11)
    ax.invert_yaxis()
    ax.set_xlabel("ì ìˆ˜(ë¬¸í•­ ìˆ˜)", fontsize=11)
    ax.legend(loc="lower right", fontsize=9)
    ax.grid(axis="x", linestyle="--", alpha=0.4)

    major_list = recommendations.get("majors", [])
    career_list = recommendations.get("careers", [])

    majors_text = "ì¶”ì²œ ì „ê³µ ì˜ˆì‹œ\n- " + "\n- ".join(major_list) if major_list else "ì¶”ì²œ ì „ê³µ ë°ì´í„° ì—†ìŒ"
    careers_text = "ì¶”ì²œ ì§ì—…êµ° ì˜ˆì‹œ\n- " + "\n- ".join(career_list) if career_list else "ì¶”ì²œ ì§ì—…êµ° ë°ì´í„° ì—†ìŒ"

    text = majors_text + "\n\n" + careers_text

    fig.text(
        0.02,
        0.02,
        "â€» ë³¸ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ê³µì‹ ì‹¬ë¦¬ê²€ì‚¬ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        fontsize=8,
        color="gray",
    )
    fig.text(
        0.52,
        0.25,
        text,
        fontsize=10,
        va="top",
        bbox=dict(boxstyle="round", facecolor="#f5f5f5", alpha=0.9),
    )

    buf = io.BytesIO()
    fig.tight_layout(rect=[0, 0.05, 1, 0.9])
    fig.savefig(buf, format="png", dpi=150)
    plt.close(fig)
    buf.seek(0)
    return buf.getvalue()


# =========================================
# 5) ì¶•ë³„ ìì—°ì–´ ì„¤ëª…
# =========================================
def build_dimension_explanation(scores: Dict[str, int]) -> List[str]:
    lines: List[str] = []

    def one_pair(a_key, b_key, a_name, b_name, label):
        a = scores[a_key]
        b = scores[b_key]
        diff = a - b
        if diff > 0:
            lines.append(
                f"- **{label}** : {a_name}({a}) ì ìˆ˜ê°€ {b_name}({b})ë³´ë‹¤ {abs(diff)}ì  ë†’ì•„ "
                f"{a_name} ìª½ ê²½í–¥ì´ ì¡°ê¸ˆ ë” ê°•í•˜ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤."
            )
        elif diff < 0:
            lines.append(
                f"- **{label}** : {b_name}({b}) ì ìˆ˜ê°€ {a_name}({a})ë³´ë‹¤ {abs(diff)}ì  ë†’ì•„ "
                f"{b_name} ìª½ ê²½í–¥ì´ ì¡°ê¸ˆ ë” ê°•í•˜ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤."
            )
        else:
            lines.append(
                f"- **{label}** : ë‘ ì„±í–¥ì˜ ì ìˆ˜ê°€ ê°™ì•„, ìƒí™©ì— ë”°ë¼ {a_name}Â·{b_name} ì„±í–¥ì´ ëª¨ë‘ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            )

    one_pair("E", "I", "ì™¸í–¥(E)", "ë‚´í–¥(I)", "ì—ë„ˆì§€ ë°©í–¥ (E / I)")
    one_pair("S", "N", "ê°ê°(S)", "ì§ê´€(N)", "ì •ë³´ ìˆ˜ìš© ë°©ì‹ (S / N)")
    one_pair("T", "F", "ì‚¬ê³ (T)", "ê°ì •(F)", "íŒë‹¨ ê¸°ì¤€ (T / F)")
    one_pair("J", "P", "íŒë‹¨(J)", "ì¸ì‹(P)", "ìƒí™œ ë°©ì‹ (J / P)")

    return lines


# =========================================
# 6) ë©”ì¸ í™”ë©´
# =========================================
st.title("ê³ ë“±í•™ìƒ ì§„ë¡œ MBTI ê²€ì‚¬")

# ê²€ì‚¬ ë‹¨ê³„
if not st.session_state.finished:
    idx = st.session_state.idx
    total = len(df)

    if idx < total:
        row = df.iloc[idx]

        st.progress((idx + 1) / total)
        st.subheader(f"{row['id']}ë²ˆ ë¬¸í•­")

        choice = st.radio(
            "",
            [row["option_a_text"], row["option_b_text"]],
            key=f"q_{row['id']}",
        )

        if st.button("ë‹¤ìŒ ë¬¸í•­ âœ", key=f"btn_next_{row['id']}"):
            if choice == row["option_a_text"]:
                st.session_state.answers[row["id"]] = row["option_a_code"]
            else:
                st.session_state.answers[row["id"]] = row["option_b_code"]

            st.session_state.idx += 1
            st.rerun()
    else:
        st.success("âœ” ëª¨ë“  ë¬¸í•­ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.")
        if st.button("ê²°ê³¼ ë³´ê¸°"):
            st.session_state.finished = True
            st.rerun()

# ê²°ê³¼ ë‹¨ê³„
else:
    mbti_type, scores = compute_mbti(df, st.session_state.answers)
    st.header("ğŸ“Š ê²€ì‚¬ ê²°ê³¼")
    st.success(f"í˜„ì¬ ì„±í–¥ì— ê¸°ë°˜í•œ MBTI ìœ í˜•ì€ **{mbti_type}** ì…ë‹ˆë‹¤.")

    # ì¶•ë³„ ì„¤ëª…
    st.markdown("#### ê²€ì‚¬ ê²°ê³¼ í•´ì„")
    for line in build_dimension_explanation(scores):
        st.markdown(line)

    # ê¸´ ì„¤ëª… (ìœ„ì—ì„œ ì •ì˜í•œ ë¦¬ìŠ¤íŠ¸)
    st.markdown("---")
    st.markdown("#### ì„±ê²©Â·í–‰ë™ íŠ¹ì§• (ê²€ì‚¬ì§€ ê¸°ë°˜ ìƒì„¸ ì„¤ëª…)")
    bullets = MBTI_PROFILES.get(mbti_type, [])
    if bullets:
        for b in bullets:
            st.markdown(f"- {b}")
    else:
        st.info("ì´ ìœ í˜•ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª… ë¬¸ì¥ì€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    # ì§„ë¡œ ì¶”ì²œ
    st.markdown("---")
    rec = MBTI_RECOMMENDATIONS.get(mbti_type, {})
    major_list = rec.get("majors", [])
    career_list = rec.get("careers", [])

    col1, col2 = st.columns(2)
    with col1:
        st.markdown("#### ì¶”ì²œ ì „ê³µ ì˜ˆì‹œ")
        if major_list:
            for m in major_list:
                st.markdown(f"- {m}")
        else:
            st.write("ì „ê³µ ì¶”ì²œ ì •ë³´ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.")
    with col2:
        st.markdown("#### ì¶”ì²œ ì§ì—…êµ° ì˜ˆì‹œ")
        if career_list:
            for c in career_list:
                st.markdown(f"- {c}")
        else:
            st.write("ì§ì—…êµ° ì¶”ì²œ ì •ë³´ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.")

    # ì ìˆ˜ ìš”ì•½
    st.markdown("---")
    st.markdown("### ì„¸ë¶€ ì ìˆ˜(ì¶•ë³„ ê²½í–¥)")
    c1, c2, c3, c4 = st.columns(4)
    with c1:
        st.metric("E (ì™¸í–¥)", scores["E"])
        st.metric("I (ë‚´í–¥)", scores["I"])
    with c2:
        st.metric("S (ê°ê°)", scores["S"])
        st.metric("N (ì§ê´€)", scores["N"])
    with c3:
        st.metric("T (ì‚¬ê³ )", scores["T"])
        st.metric("F (ê°ì •)", scores["F"])
    with c4:
        st.metric("J (íŒë‹¨)", scores["J"])
        st.metric("P (ì¸ì‹)", scores["P"])

    # PNG ë‹¤ìš´ë¡œë“œ
    st.markdown("---")
    st.markdown("### ğŸ“ ê²°ê³¼ ìš”ì•½ ì´ë¯¸ì§€(PNG) ë‹¤ìš´ë¡œë“œ")
    rec_for_fig = MBTI_RECOMMENDATIONS.get(mbti_type, {})
    png_bytes = create_result_figure(mbti_type, scores, rec_for_fig)
    st.download_button(
        label="ê²°ê³¼ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ",
        data=png_bytes,
        file_name=f"mbti_result_{mbti_type}.png",
        mime="image/png",
    )

    # ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°
    st.markdown("---")
    if st.button("ë‹¤ì‹œ ê²€ì‚¬í•˜ê¸°"):
        st.session_state.idx = 0
        st.session_state.answers = {}
        st.session_state.finished = False
        st.rerun()
